# ベースイメージ
FROM ruby:3.2.2

# 環境変数
ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo
ENV RAILS_ENV=development

# 必要パッケージをインストール
RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    postgresql-client \
    vim \
    nano \
    build-essential \
    nodejs \
    npm && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 一般ユーザーを作成
RUN useradd -m appuser

# 作業ディレクトリ
WORKDIR /app

# Gemfileをコピー＆インストール
COPY Gemfile Gemfile.lock ./
RUN gem install bundler && bundle install

# アプリ全体をコピー
COPY . .

# 所有者をappuserに変更（bind mount対策）
RUN chown -R appuser:appuser /app

# 一般ユーザーで実行
USER appuser

# Railsサーバー起動
CMD ["rails", "server", "-b", "0.0.0.0"]
