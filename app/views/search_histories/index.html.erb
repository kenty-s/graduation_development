<div class="bg-[#f8efe4] min-h-screen py-10">
  <div class="max-w-6xl mx-auto px-4 space-y-8">
    <header class="space-y-1">
      <div class="flex items-center gap-2 text-2xl font-semibold text-gray-800">
        <span class="text-xl">🕑</span>
        <span>検索履歴</span>
        <span class="text-sm text-gray-500 font-normal">過去に提案された料理の履歴です</span>
      </div>
    </header>

    <% @search_histories.each do |h| %>
      <% mood_candidate = [
        h.query_params["mood"],
        h.query_params["category"],
        (h.dish&.categories&.pluck(:name) || [])
      ].flatten.compact_blank.map(&:to_s).find { |v| v.include?("ガッツリ") || v.include?("サッパリ") } %>
      <% mood = mood_candidate %>
      <% icon, icon_bg =
        if mood&.include?("ガッツリ")
          ["gattsuri_icon.png"]
        elsif mood&.include?("サッパリ")
          ["sappari_icon.png"]
        else
          [nil, "bg-amber-800"]
        end %>
      <% dish_tags = h.dish&.category_contents || [] %>
      <% time_of_day_tags = dish_tags.any? ? dish_tags.select { |cc| cc.label == "時間帯" }.map { |cc| cc.category.name } : Array(h.query_params["time_of_day"]) %>
      <% season_tags = dish_tags.any? ? dish_tags.select { |cc| cc.label == "季節" }.map { |cc| cc.category.name } : Array(h.query_params["season"]) %>
      <% genre_tags = dish_tags.any? ? dish_tags.select { |cc| cc.label == "ジャンル" }.map { |cc| cc.category.name } : Array(h.query_params["genre"]) %>
      <% spice_param = h.query_params["spice_name"].presence || h.query_params["spice_names"] %>
      <% spice_tags = dish_tags.any? ? dish_tags.select { |cc| cc.label == "スパイス/ハーブ" }.map { |cc| cc.category.name } : Array(spice_param) %>
      <% tag_orders = {
        "時間帯" => ["朝", "昼", "夜", "おやつ"],
        "季節" => ["春", "夏", "秋", "冬"],
        "ジャンル" => ["和食", "洋食", "中華", "エスニック", "その他"],
        "スパイス/ハーブ" => ["ブラックペッパー", "ガーリック", "生姜", "唐辛子", "クミン", "コリアンダー", "ターメリック", "パプリカ", "オレガノ", "ローズマリー", "タイム", "パセリ", "ローレル", "ナツメグ", "クローブ", "山椒", "カルダモン", "シナモン", "バジル", "五香粉"]
      } %>
      <% tag_groups = {
        "時間帯" => time_of_day_tags,
        "季節" => season_tags,
        "ジャンル" => genre_tags,
        "スパイス/ハーブ" => spice_tags
      } %>

      <div class="bg-white border border-gray-200/80 rounded-2xl shadow-sm p-8 flex flex-row items-start gap-8">
        <div class="flex items-center gap-3 w-44 sm:w-56">
          <div class="w-14 h-14 rounded-full <%= icon_bg %> flex items-center justify-center overflow-hidden shrink-0">
            <% if icon %>
              <%= image_tag icon, alt: mood, class: "w-10 h-10 object-contain" %>
            <% else %>
              <span class="text-xs text-white">料理</span>
            <% end %>
          </div>
          <div>
            <p class="text-lg font-semibold text-gray-800"><%= h.dish&.name || "提案なし" %></p>
            <p class="text-xs text-gray-500"><%= h.executed_at.in_time_zone.strftime("%Y/%m/%d %H:%M") %></p>
          </div>
        </div>

        <div class="flex-1 grid grid-cols-1 sm:grid-cols-4 gap-4">
          <% tag_groups.each do |label, tags| %>
            <% sorted_tags = Array(tags).compact_blank.uniq.sort_by { |tag| tag_orders[label].index(tag) || tag_orders[label].length } %>
            <div class="bg-amber-50 border border-amber-100 rounded-xl px-4 py-3">
              <p class="text-sm font-semibold text-amber-800 text-center mb-2"><%= label %></p>
              <div class="flex flex-wrap justify-center gap-2 text-xs text-gray-700">
                <% if sorted_tags.present? %>
                  <% sorted_tags.each do |tag| %>
                    <span class="inline-flex items-center rounded-md bg-gray-200 px-3 py-1 font-semibold"><%= tag %></span>
                  <% end %>
                <% else %>
                  <span class="text-gray-400">未設定</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <%= button_to "削除",
              search_history_path(h),
              method: :delete,
              data: { turbo_confirm: "削除しますか？" },
              class: "text-sm font-semibold text-gray-600 hover:text-gray-900" %>
      </div>
    <% end %>
  </div>
</div>
